/*
 * fsm.c
 *
 *  Created on: Nov 8, 2022
 *      Author: legolas
 */


#include "global.h"
#include "fsm.h"
#include "input_reading.h"
#include "fsm_auto.h"
#include "main.h"
#include "led7seg.h"
#include "timer.h"

void fsm_run(){
	switch (state){
	case INIT:
		index_led=0;
		led_red_duration=3
		led_amber_duration=1;
		led_green_duration=2;
		setTimer1(1000);
//		setTimer2(1000);
		counter1=led_red_duration;
		counter2=led_green_duration;
		display_led7_seg(counter1);
		light_state1=0;
		light_state2=0;
		state=NORMAL;
		break;
	case NORMAL:
//		if(timer_flag[2]==1){
//			//led_scanning
//			setTimer(2,1000);
//			update7seg(index_led);
//			if(index_led==0) index_led=1;
//			else 			 index_led=0;
//		}
		enable_7seg(0);
		if(timer1_flag==1) {
			//update light_state: red, yellow or green according to light_state
			fsm_auto_run_for_led_7seg_1();
			fsm_auto_run_for_led_7seg_2();
			counter1--;
			counter2--;
			display_led7_seg(counter1);
			//when counter reach 0, change color and duration
			if(counter1==0) {
				light_state1++;
				if(light_state1>2) light_state1=0;
				switch (light_state1){
					case 0://red
						counter1=led_amber_duration;
						break;
					case 1://amber
						counter1=led_green_duration;
						break;
					case 2://green
						counter1=led_red_duration;
						break;
					default:
						break;
					}
			}
			if(counter2==0) {
							light_state2++;
							if(light_state2>=3) light_state2=0;
							switch (light_state2){
								case 0://green
									counter2=led_amber_duration;
									break;
								case 1://amber
									counter2=led_red_duration;
									break;
								case 2://red
									counter2=led_green_duration;
									break;
								default:
									break;
								}
						}
			setTimer1(1000);	//counter is decrease every 1 second
		}



		//if first button is pressed, mode will change to MODIFY_RED
		if(button_flag[0]==1)
			{
			button_flag[0]=0;
			state=MODIFY_RED;
			}
		break;
	case MODIFY_RED:
		enable_7seg(0);
		display_led7_seg(led_red_duration);
		//second button is used to increase the red_duration value
		if(button_flag[1]==1) {
			button_flag[1]=0;
		}
		//third button is used to set the value for red led
		if(button_flag[2]==1) {
					button_flag[2]=0;
				}
		//if first button is pressed, mode will change to MODIFY_AMBER
		if(button_flag[0]==1)
			{
			button_flag[0]=0;
			state=MODIFY_AMBER;
			}
		break;
	case MODIFY_AMBER:
		if(button_flag[0]==1)
			{
			button_flag[0]=0;
			state=MODIFY_GREEN;
			//turn off all led7seg to prepare for next mode
			HAL_GPIO_WritePin(EN0_GPIO_Port, EN0_Pin, SET);
			HAL_GPIO_WritePin(EN1_GPIO_Port, EN1_Pin, SET);

			}
			break;
	case MODIFY_GREEN:
		if(button_flag[0]==1)
			{
			button_flag[0]=0;
			state=NORMAL;
			//turn off all led7seg to prepare for next mode
			HAL_GPIO_WritePin(EN0_GPIO_Port, EN0_Pin, SET);
			HAL_GPIO_WritePin(EN1_GPIO_Port, EN1_Pin, SET);

			}
			break;
	default:
		break;
	}
	return;
}
